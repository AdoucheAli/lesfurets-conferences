From a7989e0dce236ce7fb77e0f47aaf1b3316daca67 Mon Sep 17 00:00:00 2001
From: Alexandre DuBreuil <adu@lesfurets.com>
Date: Fri, 19 May 2017 16:53:47 +0200
Subject: [PATCH] Add jOOQ example with FichesAuto SQL

---
 src/jOOQ/pom.xml                                   |  5 +--
 .../java/com/lesfurets/db/dao/FicheAutoDAO.java    | 34 ++++++++++++++++++++
 .../com/lesfurets/db/dao/LegacyFicheAutoDAO.java   | 37 ++++++++++++++++++++++
 src/jOOQ/src/main/resources/schema_fiches_auto.sql | 26 +++++++++++++++
 4 files changed, 98 insertions(+), 4 deletions(-)
 create mode 100644 src/jOOQ/src/main/java/com/lesfurets/db/dao/FicheAutoDAO.java
 create mode 100644 src/jOOQ/src/main/java/com/lesfurets/db/dao/LegacyFicheAutoDAO.java
 create mode 100644 src/jOOQ/src/main/resources/schema_fiches_auto.sql

diff --git a/src/jOOQ/pom.xml b/src/jOOQ/pom.xml
index aa48231..550c2e3 100644
--- a/src/jOOQ/pom.xml
+++ b/src/jOOQ/pom.xml
@@ -81,10 +81,6 @@
                 <artifactId>sql-maven-plugin</artifactId>
                 <version>1.5</version>
 
-                <configuration>
-                    <forkMode>always</forkMode>
-                </configuration>
-
                 <executions>
                     <execution>
                         <id>create-database-h2</id>
@@ -104,6 +100,7 @@
                             <autocommit>true</autocommit>
                             <srcFiles>
                                 <srcFile>src/main/resources/schema.sql</srcFile>
+                                <srcFile>src/main/resources/schema_fiches_auto.sql</srcFile>
                             </srcFiles>
                         </configuration>
                     </execution>
diff --git a/src/jOOQ/src/main/java/com/lesfurets/db/dao/FicheAutoDAO.java b/src/jOOQ/src/main/java/com/lesfurets/db/dao/FicheAutoDAO.java
new file mode 100644
index 0000000..7ba5f4e
--- /dev/null
+++ b/src/jOOQ/src/main/java/com/lesfurets/db/dao/FicheAutoDAO.java
@@ -0,0 +1,34 @@
+package com.lesfurets.db.dao;
+
+import org.jooq.impl.DSL;
+
+import java.sql.Connection;
+
+import static com.lesfurets.db.tables.FichesAuto.FICHES_AUTO;
+import static org.jooq.impl.DSL.trueCondition;
+
+public class FicheAutoDAO {
+
+    public String readXmlArchive(Connection conn, String offreUid, String provider, Integer statut)
+            throws Exception {
+        String xml = DSL
+                .using(conn)
+                .select(FICHES_AUTO.ID)
+                .select(FICHES_AUTO.OFFRE_UID)
+                .select(FICHES_AUTO.STATUT)
+                .select(FICHES_AUTO.XML)
+                .from(FICHES_AUTO)
+                .where(FICHES_AUTO.OFFRE_UID.equal(offreUid))
+                .and(provider == null ? trueCondition() : FICHES_AUTO.PROVIDER.equal(provider))
+                .and(statut == null ? trueCondition() : FICHES_AUTO.STATUT.equal(statut))
+                .orderBy(FICHES_AUTO.ID.desc(), FICHES_AUTO.STATUT.desc())
+                .limit(1)
+                .fetchOptional()
+                .orElseThrow(() -> new Exception(offreUid)).get(FICHES_AUTO.XML);
+        if (xml == null || xml.isEmpty()) {
+            throw new Exception(offreUid);
+        }
+        return xml;
+    }
+
+}
diff --git a/src/jOOQ/src/main/java/com/lesfurets/db/dao/LegacyFicheAutoDAO.java b/src/jOOQ/src/main/java/com/lesfurets/db/dao/LegacyFicheAutoDAO.java
new file mode 100644
index 0000000..fbab49b
--- /dev/null
+++ b/src/jOOQ/src/main/java/com/lesfurets/db/dao/LegacyFicheAutoDAO.java
@@ -0,0 +1,37 @@
+package com.lesfurets.db.dao;
+
+import java.sql.Connection;
+import java.sql.PreparedStatement;
+import java.sql.ResultSet;
+
+public class LegacyFicheAutoDAO {
+
+    private static final String COL_ID = "id";
+    private static final String COL_OFFRE_UID = "offre_uid";
+    private static final String COL_STATUT = "statut";
+    private static final String COL_XML = "xml";
+
+    private static final String TABLE_FICHES_AUTO = "FICHES_AUTO";
+
+    private final String SELECT_ONE = "SELECT " + COL_ID + ", " + COL_OFFRE_UID + ", " + COL_STATUT + ", " + COL_XML +
+            " FROM " + TABLE_FICHES_AUTO +
+            " WHERE offre_uid=? " + //
+            " ORDER BY id DESC, statut DESC LIMIT 0,1 ";
+
+    public String readXmlArchive(Connection conn, String offreUid) throws Exception {
+        try (PreparedStatement ps = conn.prepareStatement(SELECT_ONE)) {
+            ps.setString(1, offreUid);
+            try (ResultSet rs = ps.executeQuery()) {
+                if (!rs.next()) {
+                    throw new Exception(offreUid);
+                }
+                String xml = rs.getString(COL_XML);
+                if (xml == null || xml.isEmpty()) {
+                    throw new Exception(offreUid);
+                }
+                return xml;
+            }
+        }
+    }
+
+}
\ No newline at end of file
diff --git a/src/jOOQ/src/main/resources/schema_fiches_auto.sql b/src/jOOQ/src/main/resources/schema_fiches_auto.sql
new file mode 100644
index 0000000..ac2b67f
--- /dev/null
+++ b/src/jOOQ/src/main/resources/schema_fiches_auto.sql
@@ -0,0 +1,26 @@
+DROP TABLE IF EXISTS FICHES_AUTO;
+CREATE TABLE FICHES_AUTO (
+  id int(11) NOT NULL AUTO_INCREMENT,
+  offre_uid varchar(32) NOT NULL,
+  creation_date varchar(32) NOT NULL,
+  creation_time varchar(32) NOT NULL,
+  code_postal char(5),
+  telephone varchar(50),
+  prenom varchar(100),
+  nom varchar(150),
+  email varchar(150),
+  sexe int(4),
+  age int(4),
+  csp int(4),
+  crm int(6),
+  code_sra varchar(7),
+  code_postal_vehicule char(5),
+  date_achat varchar(32),
+  provider varchar(32),
+  statut int,
+  xml varchar(1024),
+  PRIMARY KEY (id)
+);
+
+INSERT INTO FICHES_AUTO (offre_uid, creation_date, creation_time, code_postal, telephone, prenom, nom, email, sexe, age, csp, crm, code_sra, code_postal_vehicule, date_achat, provider, statut, xml)
+  VALUES ('0001495183264276b2c00000e6b55262', '2017-05-19', '11:43:12', '75011', '0987654321', 'Alex', 'Dub', 'monmail@example.com', 1, 25, 5, 50, 'BMW1000', '75020', '2016-04-18', 'assureur', 100, '<xml>');
-- 
2.9.3

